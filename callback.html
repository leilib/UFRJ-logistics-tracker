<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Callback</title></head>
<body>
  <h1>Authorization successful</h1>
  <p>Getting your access token...</p>
  <script type="module">
    const CLIENT_ID = "4602042605636246";
    const REDIRECT_URI = "https://leilib.github.io/callback";
    const TOKEN_URL = "https://api.mercadolibre.com/oauth/token";

    const code = new URLSearchParams(location.search).get("code");
    const verifier = sessionStorage.getItem("pkce_verifier");

    if (code && verifier) {
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CLIENT_ID,
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
      });

      fetch(TOKEN_URL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body.toString()
      })
      .then(res => res.json())
      .then(data => {
        console.log("Access token:", data.access_token);
        sessionStorage.setItem("ml_access_token", data.access_token);
        document.body.insertAdjacentHTML("beforeend", "<p>Token received. You can close this tab.</p>");
      })
      .catch(err => {
        console.error(err);
        document.body.insertAdjacentHTML("beforeend", `<p>Error: ${err.message}</p>`);
      });
    } else {
      document.body.insertAdjacentHTML("beforeend", "<p>Missing code or verifier.</p>");
    }
  </script>
</body>
</html>
