<script type="module">
  const CLIENT_ID = "4602042605636246";
  const REDIRECT_URI = "https://leilib.github.io/UFRJ-logistics-tracker/callback";

  const code = new URLSearchParams(location.search).get("code");
  const verifier = sessionStorage.getItem("pkce_verifier");

  if (code && verifier) {
    console.log("Code:", code);
    console.log("Verifier:", verifier);

    fetch("https://ufrj-logistics-tracker.vercel.app/api/exchange-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, redirect_uri: REDIRECT_URI, verifier })
    })
      .then(async res => {
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error ? JSON.stringify(data.error) : "Token exchange failed");
        }
        return data;
      })
      .then(data => {
        console.log("Access token:", data.access_token);
        sessionStorage.setItem("ml_access_token", data.access_token);
        document.body.insertAdjacentHTML("beforeend", "<p>Token received. You can close this tab.</p>");
      })
      .catch(err => {
        console.error("Exchange error:", err);
        document.body.insertAdjacentHTML("beforeend", `<p>Error: ${err}</p>`);
      });

  } else {
    document.body.insertAdjacentHTML("beforeend", "<p>Missing code or verifier.</p>");
  }
</script>
